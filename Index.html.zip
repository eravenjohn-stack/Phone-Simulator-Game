import React, { useState, useEffect } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc } from 'firebase/firestore';

const getFirebaseConfig = () => {
  try {
    if (typeof __initial_firebase_config !== 'undefined') return JSON.parse(__initial_firebase_config);
    if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
  } catch (e) { return null; }
};

const firebaseConfig = getFirebaseConfig();
let app, auth, db;
if (firebaseConfig && getApps().length === 0) {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} else if (getApps().length > 0) {
  app = getApps()[0];
  auth = getAuth(app);
  db = getFirestore(app);
}

const appId = typeof __app_id !== 'undefined' ? __app_id : 'ravens-kawaii-v8';

export default function App() {
  const [user, setUser] = useState(null);
  const [step, setStep] = useState('welcome'); 
  const [slots, setSlots] = useState([]);
  const [phoneState, setPhoneState] = useState({
    name: '',
    font: "'Quicksand', sans-serif",
    wallpaper: 'pink',
    password: '',
    slotId: null,
    gallery: [],
    notes: []
  });

  const [activeApp, setActiveApp] = useState(null);
  const [isLocked, setIsLocked] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [battery, setBattery] = useState({ level: 100, charging: false });
  const [unlockInput, setUnlockInput] = useState('');
  const [isPasswordWrong, setIsPasswordWrong] = useState(false);
  const [showNameConfirm, setShowNameConfirm] = useState(false);
  
  // App Specific States
  const [calcDisplay, setCalcDisplay] = useState('0');
  const [gallerySelected, setGallerySelected] = useState(null);
  const [showAddPhotoModal, setShowAddPhotoModal] = useState(false);
  const [photoUrlInput, setPhotoUrlInput] = useState('');
  const [newNote, setNewNote] = useState({ title: '', body: '' });

  const themes = {
    pink: { bg: 'linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%)', accent: '#ff85a2', dark: '#d63384' },
    mint: { bg: 'linear-gradient(135deg, #e3fdf5 0%, #ffe6fa 100%)', accent: '#74ebd5', dark: '#00b894' },
    lavender: { bg: 'linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%)', accent: '#a18cd1', dark: '#6c5ce7' },
    sunny: { bg: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)', accent: '#fab1a0', dark: '#e17055' },
    berry: { bg: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', accent: '#ff758c', dark: '#d63031' },
    ocean: { bg: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)', accent: '#74b9ff', dark: '#0984e3' },
    matcha: { bg: 'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)', accent: '#55efc4', dark: '#00b894' },
    sky: { bg: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)', accent: '#00d2ff', dark: '#2e86de' },
    choco: { bg: 'linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%)', accent: '#b2bec3', dark: '#636e72' },
    night: { bg: 'linear-gradient(to bottom, #2b5876, #4e4376)', accent: '#9c88ff', dark: '#4834d4' }
  };

  const currentTheme = themes[phoneState.wallpaper] || themes.pink;

  useEffect(() => {
    if (!auth) return;
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else { await signInAnonymously(auth); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'saves');
    return onSnapshot(q, (snap) => {
      const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setSlots(data.sort((a, b) => b.timestamp - a.timestamp));
    });
  }, [user]);

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    if ('getBattery' in navigator) {
      navigator.getBattery().then(bat => {
        const updateBattery = () => {
          setBattery({
            level: Math.round(bat.level * 100),
            charging: bat.charging
          });
        };
        updateBattery();
        bat.addEventListener('levelchange', updateBattery);
        bat.addEventListener('chargingchange', updateBattery);
      });
    }
    return () => clearInterval(timer);
  }, []);

  const saveGame = async () => {
    if (!user || !db) return;
    const data = { ...phoneState, timestamp: Date.now(), lastSaved: new Date().toLocaleString() };
    if (phoneState.slotId) {
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'saves', phoneState.slotId), data);
    } else {
      const res = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'saves'), data);
      setPhoneState(p => ({ ...p, slotId: res.id }));
    }
    setActiveApp('saved-notif');
    setTimeout(() => setActiveApp('settings'), 1000);
  };

  const calcInput = (val) => {
    if (val === 'C') return setCalcDisplay('0');
    if (val === '=') {
      try {
        const result = Function(`'use strict'; return (${calcDisplay})`)();
        setCalcDisplay(String(result));
      } catch { setCalcDisplay('Error'); }
      return;
    }
    setCalcDisplay(prev => prev === '0' || prev === 'Error' ? val : prev + val);
  };

  const handleConfirmAddPhoto = () => {
    if (photoUrlInput && photoUrlInput.trim().startsWith('http')) {
      setPhoneState(prev => ({
        ...prev,
        gallery: [...prev.gallery, { url: photoUrlInput.trim(), note: '' }]
      }));
      setPhotoUrlInput('');
      setShowAddPhotoModal(false);
    }
  };

  const timeStr = currentTime.getHours().toString().padStart(2, '0') + ":" + currentTime.getMinutes().toString().padStart(2, '0');

  return (
    <div className="min-h-screen bg-[#fff0f3] flex items-center justify-center p-4 overflow-hidden" style={{ fontFamily: phoneState.font }}>
      <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Lexend:wght@500;800&family=Gaegu:wght@700&family=Cherry+Bomb+One&display=swap" rel="stylesheet" />
      <style>{`
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes popIn { 0% { transform: scale(0.7); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(100%); } 100% { transform: translateY(0); } }
        @keyframes slideDown { 0% { transform: translateY(-100%); } 100% { transform: translateY(0); } }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        
        .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-slide-down { animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in forwards; }
        .animate-shake { animation: shake 0.1s ease-in-out 5; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .app-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
      `}</style>

      <div className="relative w-[340px] h-[680px] bg-white rounded-[60px] border-[12px] border-[#ffd1dc] shadow-[0_25px_50px_-12px_rgba(255,182,193,0.5)] overflow-hidden flex flex-col">
        
        {/* START SCREENS */}
        {(['welcome', 'info', 'start-menu', 'slots', 'setup'].includes(step)) && (
          <div className="absolute inset-0 z-[500] bg-white p-8 flex flex-col items-center justify-center text-center animate-fade-in">
            {step === 'welcome' && (
              <div className="animate-pop-in flex flex-col items-center">
                <div className="text-7xl mb-6 animate-float">üç≠</div>
                <h1 className="text-3xl font-bold text-[#ff85a2] mb-10" style={{ fontFamily: "'Cherry Bomb One'" }}>Welcome Owner</h1>
                <button onClick={() => setStep('info')} className="bg-[#ff85a2] text-white px-12 py-4 rounded-full font-bold shadow-[0_10px_0_#d63384] active:translate-y-1 active:shadow-none transition-all transform hover:scale-105">Start Game</button>
              </div>
            )}

            {step === 'info' && (
              <div className="text-left w-full space-y-4 animate-slide-up">
                <h2 className="text-xl font-bold text-[#ff85a2] mb-4">Hello! ü§ó</h2>
                <p className="text-sm text-pink-400 leading-relaxed">
                  Welcome to Ravenscreativity! Here are a few things to know:
                </p>
                <div className="bg-[#fff0f3] p-4 rounded-[25px] border-b-4 border-pink-100 animate-pop-in">
                  <p className="text-xs text-pink-500 font-bold mb-2">1. Save your game progress in the Save button inside the Settings App</p>
                  <p className="text-xs text-pink-500 font-bold">2. E.N.J.O.Y</p>
                </div>
                <button onClick={() => setStep('start-menu')} className="w-full bg-[#ff85a2] text-white p-5 rounded-[30px] font-bold shadow-[0_10px_0_#d63384] active:translate-y-1 active:shadow-none mt-6 animate-pop-in">Got it!</button>
              </div>
            )}

            {step === 'start-menu' && (
              <div className="w-full space-y-6 animate-pop-in">
                <div className="text-5xl mb-4 animate-float">üéÄ</div>
                <button onClick={() => setStep('setup')} className="w-full bg-[#fff0f3] text-[#ff85a2] p-5 rounded-[30px] font-bold border-2 border-transparent hover:border-[#ff85a2] transition-all transform hover:translate-x-1">New Profile</button>
                <button onClick={() => setStep('slots')} className="w-full bg-[#ff85a2] text-white p-5 rounded-[30px] font-bold shadow-[0_10px_0_#d63384] active:translate-y-1 active:shadow-none transform hover:translate-x-1">Load Memories</button>
              </div>
            )}

            {step === 'setup' && (
              <div className="w-full animate-slide-up">
                {!showNameConfirm ? (
                  <div>
                    <h2 className="text-2xl font-bold mb-6 text-[#ff85a2]">What is your name?</h2>
                    <input 
                      className="w-full p-5 bg-[#fff0f3] rounded-[25px] mb-6 text-center text-[#ff85a2] font-bold outline-none border-2 border-transparent focus:border-[#ff85a2] shadow-inner transition-all" 
                      placeholder="Your name..." 
                      value={phoneState.name} 
                      onChange={e => setPhoneState({...phoneState, name: e.target.value})} 
                    />
                    <button 
                      onClick={() => { if(phoneState.name.trim()) setShowNameConfirm(true); }} 
                      className="w-full bg-[#ff85a2] text-white p-5 rounded-[30px] font-bold shadow-[0_10px_0_#d63384] active:scale-95 transition-transform"
                    >Confirm ‚ú®</button>
                  </div>
                ) : (
                  <div className="animate-pop-in">
                    <div className="text-5xl mb-4">ü§î</div>
                    <h2 className="text-xl font-bold text-[#ff85a2] mb-6">Are you sure you want to be called "<span className="text-pink-600 underline">{phoneState.name}</span>"?</h2>
                    <div className="flex gap-4">
                      <button onClick={() => setShowNameConfirm(false)} className="flex-1 bg-pink-50 text-pink-300 p-4 rounded-[25px] font-bold hover:bg-pink-100 transition-colors">No</button>
                      <button onClick={() => { setStep('os'); setShowNameConfirm(false); }} className="flex-1 bg-[#ff85a2] text-white p-4 rounded-[25px] font-bold shadow-[0_6px_0_#d63384] active:translate-y-1 active:shadow-none">Yes!</button>
                    </div>
                  </div>
                )}
              </div>
            )}

            {step === 'slots' && (
              <div className="w-full text-left overflow-y-auto max-h-full pb-10 px-2 hide-scrollbar animate-slide-up">
                <button onClick={() => setStep('start-menu')} className="mb-6 text-[#ff85a2] font-bold flex items-center gap-2 hover:translate-x-[-4px] transition-transform">‚Üê Back</button>
                {slots.length === 0 ? (
                    <p className="text-center text-pink-200 mt-20 italic">No saves found yet...</p>
                ) : slots.map((s, idx) => (
                  <div key={s.id} onClick={() => {setPhoneState(s); setStep('os');}} 
                    className="p-5 bg-[#fff0f3] mb-4 rounded-[25px] border-b-4 border-[#ffd1dc] cursor-pointer hover:bg-pink-50 transition-all transform hover:scale-[1.02] animate-pop-in">
                    <div className="font-bold text-[#ff85a2]">{s.name}</div>
                    <div className="text-[10px] text-pink-300 font-bold">{s.lastSaved}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* OS */}
        {step === 'os' && (
          <div className="flex-1 flex flex-col relative overflow-hidden app-transition animate-fade-in" style={{ background: currentTheme.bg }}>
            {/* Status Bar */}
            <div className="h-10 px-6 flex justify-between items-center text-pink-500/80 text-[10px] font-bold z-50">
              <span className="bg-white/40 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm">{timeStr}</span>
              <span className="bg-white/40 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm flex items-center gap-1">
                {battery.level}% üç¨
              </span>
            </div>

            {/* Lock Screen */}
            {isLocked && (
              <div className="absolute inset-0 z-[400] bg-white/30 backdrop-blur-md flex flex-col items-center justify-center p-8 text-pink-500 text-center animate-fade-in">
                <div className="text-6xl font-bold mb-10 drop-shadow-lg animate-float" style={{ fontFamily: "'Cherry Bomb One'" }}>{timeStr}</div>
                {phoneState.password && (
                  <div className={`w-full ${isPasswordWrong ? 'animate-shake' : ''}`}>
                    <input 
                      type="password" placeholder="Passcode" value={unlockInput}
                      onChange={e => setUnlockInput(e.target.value)}
                      className="w-full p-5 rounded-[25px] bg-white border-2 text-center outline-none mb-6 shadow-sm border-pink-100 focus:border-pink-300"
                    />
                  </div>
                )}
                <button onClick={() => {
                  if(!phoneState.password || unlockInput === phoneState.password) {
                    setIsLocked(false); setUnlockInput('');
                  } else {
                    setIsPasswordWrong(true); setTimeout(() => setIsPasswordWrong(false), 1000);
                  }
                }} className="bg-[#ff85a2] text-white px-16 py-4 rounded-full font-bold shadow-[0_8px_0_#d63384] active:translate-y-1 active:shadow-none animate-pop-in">Unlock ‚ú®</button>
              </div>
            )}

            {/* Home Screen Icons */}
            <div className={`flex-1 p-8 grid grid-cols-3 content-start gap-8 mt-12 transition-all duration-500 ${isLocked ? 'blur-lg scale-110 opacity-50' : 'opacity-100 scale-100'}`}>
              <div className="col-span-3 text-center mb-10 animate-float">
                <h1 className="text-white text-3xl font-bold drop-shadow-[0_4px_6px_rgba(0,0,0,0.2)] mb-1" style={{ fontFamily: "'Cherry Bomb One'" }}>{phoneState.name}</h1>
                <p className="text-white/90 text-[9px] uppercase tracking-widest font-bold bg-black/10 inline-block px-4 py-1 rounded-full backdrop-blur-sm">Owner Edition OS</p>
              </div>
              
              {[
                {id: 'gallery', icon: 'üé®', label: 'Album'},
                {id: 'calculator', icon: 'üç∞', label: 'Calc'},
                {id: 'notepad', icon: 'üíå', label: 'Diary'},
                {id: 'settings', icon: 'üß∏', label: 'Setup'}
              ].map((app) => (
                <div key={app.id} onClick={() => setActiveApp(app.id)} className="flex flex-col items-center gap-2 cursor-pointer group animate-pop-in">
                  <div className="w-16 h-16 glass rounded-[25px] flex items-center justify-center text-3xl shadow-md group-hover:scale-110 group-active:scale-90 transition-all">
                    {app.icon}
                  </div>
                  <span className="text-white text-[10px] font-bold drop-shadow-md">{app.label}</span>
                </div>
              ))}
              
              <div onClick={() => setIsLocked(true)} className="flex flex-col items-center gap-2 cursor-pointer group animate-pop-in">
                <div className="w-16 h-16 glass rounded-[25px] flex items-center justify-center text-3xl shadow-md group-hover:scale-110 group-active:scale-95 transition-all">üóùÔ∏è</div>
                <span className="text-white text-[10px] font-bold drop-shadow-md">Lock</span>
              </div>
            </div>

            {/* Full Screen App Layers */}
            {activeApp && activeApp !== 'saved-notif' && (
              <div className="absolute inset-0 z-[500] bg-[#fff9fb] animate-slide-up flex flex-col shadow-2xl">
                <div className="h-16 flex items-center justify-between px-6 border-b border-pink-50 z-[501]">
                  <h3 className="font-bold text-[#ff85a2] text-lg capitalize">{activeApp}</h3>
                  <div className="flex gap-3">
                    {activeApp === 'gallery' && (
                      <button 
                        onClick={() => setShowAddPhotoModal(true)} 
                        style={{backgroundColor: currentTheme.accent}} 
                        className="w-10 h-10 rounded-full text-white font-bold shadow-sm hover:scale-110 active:scale-90 transition-all flex items-center justify-center text-xl z-[502]"
                      >+</button>
                    )}
                    <button onClick={() => {setActiveApp(null); setGallerySelected(null);}} className="text-pink-200 text-2xl hover:text-pink-400">‚úï</button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto p-5 hide-scrollbar relative">
                  {activeApp === 'gallery' && (
                    <div className="grid grid-cols-2 gap-4 pb-20">
                      {phoneState.gallery.length === 0 && (
                        <div className="col-span-2 text-center mt-20">
                          <p className="text-pink-200 italic mb-4">No photos yet... üå∏</p>
                          <button 
                            onClick={() => setShowAddPhotoModal(true)} 
                            className="text-white bg-pink-300 px-6 py-2 rounded-full font-bold text-xs"
                          >Add First Memory</button>
                        </div>
                      )}
                      {phoneState.gallery.map((img, i) => (
                        <div key={i} onClick={() => setGallerySelected(i)} className="aspect-square bg-white rounded-[25px] overflow-hidden border-4 border-white shadow-sm hover:scale-105 transition-all animate-pop-in">
                          <img src={img.url} className="w-full h-full object-cover" onError={(e) => { e.target.src = "https://images.unsplash.com/photo-1518717758536-85ae29035b6d?auto=